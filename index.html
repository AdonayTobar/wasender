<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WA Sender - Categor√≠as de Color Suave</title>
    

<script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuraci√≥n de fuente Inter (preferida) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6; /* Fondo gris muy suave */
        }
        
        /* Estilos mejorados para los botones principales */
        .primary-button {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 0.5rem;
            font-weight: 600;
        }

        /* Estilo para los √≠tems de contacto */
        .contact-item {
            transition: all 0.2s ease;
        }
        .contact-item:hover {
            background-color: #F9FAFB;
        }
        
        /* Ocultar el scroll del body y mantener el scroll solo si es necesario para el contenido total */
        html, body {
            overflow-x: hidden;
        }
        
        /* Clase especial para aplicar colores din√°micos a los badges */
        /* Nota: el color de fondo se define con el alfa (transparencia) en JS para un efecto suave */
        .color-badge {
            background-color: var(--badge-bg-color);
            color: var(--badge-text-color);
            border-color: var(--badge-border-color);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // √öNICO AZUL (AZUL OSCURO, CORPORATIVO)
                        'brand-blue': '#2C5282',
                        // √öNICO VERDE (√âXITO)
                        'brand-success': '#10B981',
                        // √öNICO ROJO (PELIGRO/SALIR)
                        'brand-danger': '#EF4444',
                        // √öNICO NARANJA/√ÅMBAR (ACENTO/PROYECTO/MODIFICAR/DETALLES)
                        'brand-accent': '#FBBF24', 
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    

<div id="crm-app-container" class="max-w-7xl w-full mx-auto bg-white shadow-2xl border border-gray-100 rounded-xl p-8 space-y-8 mt-6 hidden">
        
        <!-- BARRA DE NAVEGACI√ìN SUPERIOR PROFESIONAL -->
        <nav class="flex justify-between items-center py-4 border-b border-gray-100">
            <!-- Logo -->
            <h1 class="text-3xl font-extrabold text-gray-900">
                <span class="text-brand-blue">WA Sender</span>
            </h1>
            
            <!-- Botones de Perfil y Salir -->
            <div class="flex items-center space-x-3">
                <button onclick="toggleProfileView()" 
                        id="profileButton"
                        class="primary-button text-sm font-semibold px-3 py-2 bg-blue-50 text-brand-blue hover:bg-brand-blue hover:text-white shadow-md border border-blue-100">
                    <span>Perfil</span>
                </button>
                <button onclick="logout()" 
                        class="primary-button text-sm text-white font-semibold px-3 py-2 bg-brand-danger hover:bg-red-600 shadow-md">
                    <span>Salir</span>
                </button>
            </div>
        </nav>
        
        <!-- BANNER DE BIENVENIDA PROFESIONAL -->
        <div class="bg-brand-blue/10 p-4 rounded-lg border border-brand-blue/30 shadow-inner">
            <p class="text-md font-medium text-gray-700">
                Hola <span id="currentUserName" class="text-brand-blue font-extrabold">Usuario</span>, un gusto tenerte de nuevo.
            </p>
        </div>


        

<div id="main-crm-content" class="space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
                

<div class="lg:col-span-1 space-y-6">
                    
                    <!-- 1. Administrar Categor√≠as -->
                    <div class="card p-6 rounded-xl space-y-3 bg-white shadow-xl border border-gray-200">
                        <h2 class="text-xl font-bold text-gray-800 border-b pb-2">
                            Administrar Categor√≠as
                        </h2>
                        
                        

<div class="flex space-x-2">
                            <input type="text" id="newCategoryName" placeholder="Nueva categor√≠a (Ej: VIP)"
                                   class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 ring-brand-blue focus:border-brand-blue text-sm shadow-sm" />
                            <input type="color" id="newCategoryColor" value="#2C5282" title="Color de Etiqueta"
                                   class="h-10 w-10 p-1 border border-gray-300 rounded-lg shadow-sm cursor-pointer"/>
                            <button onclick="addCategory()"
                                    class="p-3 rounded-lg bg-brand-blue text-white font-semibold text-sm hover:bg-brand-blue/90 transition duration-200 shadow-md">
                                Crear
                            </button>
                        </div>

                        
                        <div class="pt-3">
                            <div class="flex flex-wrap gap-2 mb-3" id="categoryBadges">
                                

</div>
                            <button onclick="openCategoryEditModal()" 
                                    class="w-full text-sm font-semibold px-3 py-2 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-lg border border-gray-300 transition duration-200">
                                Editar Nombre y Color
                            </button>
                        </div>
                    </div>

                    <!-- 2. Agregar/Editar Contacto -->
                    <div id="addEditContactSection" class="card p-6 rounded-xl space-y-4 bg-white shadow-xl border border-gray-200">
                        <h2 id="formTitle" class="text-xl font-bold text-gray-800 border-b pb-2">
                            Agregar Nuevo Contacto
                        </h2>
                        
                        

<input type="text" id="inputFirstName" placeholder="Nombre"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 ring-brand-blue focus:border-brand-blue text-sm shadow-sm" />
                        <input type="text" id="inputLastName" placeholder="Apellido"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 ring-brand-blue focus:border-brand-blue text-sm shadow-sm" />
                        
                        
                        <input type="text" id="inputPhone" placeholder="Tel√©fono (8 d√≠gitos, ej: 78451234)"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 ring-brand-blue focus:border-brand-blue text-sm shadow-sm" />
                        
                        

<input type="text" id="inputAddress" placeholder="Direcci√≥n Completa (Obligatorio)"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 ring-brand-blue focus:border-brand-blue text-sm shadow-sm" />


                        

<div class="p-3 border border-gray-200 rounded-lg max-h-40 overflow-y-auto bg-gray-50">
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                Categor√≠as:
                            </label>
                            <div id="categoryCheckboxes" class="space-y-1">
                                

</div>
                        </div>

                        

<div id="projectFieldsContainer" class="p-4 bg-brand-accent/10 border border-brand-accent/50 rounded-lg space-y-3 hidden shadow-inner">
                            <h3 class="text-sm font-bold text-brand-accent">Detalles de Proyecto:</h3>
                            <input type="text" id="inputProjectLocation" placeholder="Lugar del Proyecto"
                                class="w-full p-3 border border-brand-accent/50 rounded-lg focus:ring-2 ring-brand-accent focus:border-brand-accent text-sm shadow-sm" />
                            <input type="text" id="inputProjectStatus" placeholder="Estado del Proyecto"
                                class="w-full p-3 border border-brand-accent/50 rounded-lg focus:ring-2 ring-brand-accent focus:border-brand-accent text-sm shadow-sm" />
                        </div>

                        <div class="flex space-x-3 pt-2">
                            <button id="addEditButton" onclick="addOrUpdateContact()"
                                    class="flex-1 p-3 rounded-lg bg-brand-blue text-white font-semibold text-sm hover:bg-brand-blue/90 transition duration-200 shadow-lg">
                                Guardar Contacto
                            </button>
                            <button id="cancelEditButton" onclick="cancelEdit()"
                                    class="hidden p-3 rounded-lg bg-gray-500 text-white font-semibold text-sm hover:bg-gray-600 transition duration-200 shadow-md">
                                Cancelar Edici√≥n
                            </button>
                        </div>
                    </div>

                    <!-- 3. Plantilla de Mensaje -->
                    <div class="card p-6 rounded-xl space-y-3 bg-white shadow-xl border border-gray-200">
                        <h2 class="text-xl font-bold text-gray-800 border-b pb-2">
                            Plantilla de Mensaje
                        </h2>
                        
                        <label class="block text-sm font-medium text-gray-700">
                            Arrastra y suelta variables:
                        </label>
                        <div class="flex flex-wrap space-x-2 mb-2">
                            <span draggable="true" ondragstart="dragStart(event, '{{Nombre}}')"
                                  class="draggable-item bg-blue-100 text-blue-800 text-xs font-medium px-3 py-1 rounded-full border border-blue-300 shadow-sm cursor-grab hover:bg-blue-200">
                                Nombre
                            </span>
                            <span draggable="true" ondragstart="dragStart(event, '{{Apellido}}')"
                                  class="draggable-item bg-blue-100 text-blue-800 text-xs font-medium px-3 py-1 rounded-full border border-blue-300 shadow-sm cursor-grab hover:bg-blue-200">
                                Apellido
                            </span>
                             <span draggable="true" ondragstart="dragStart(event, '{{Direcci√≥n}}')"
                                  class="draggable-item bg-blue-100 text-blue-800 text-xs font-medium px-3 py-1 rounded-full border border-blue-300 shadow-sm cursor-grab hover:bg-blue-200">
                                Direcci√≥n
                            </span>
                        </div>

                        <textarea id="messageTemplate" placeholder="Hola {{Nombre}}, te contacto por..." rows="6"
                                  ondragover="allowDrop(event)" ondrop="drop(event)"
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 ring-brand-success focus:border-brand-success transition duration-150 shadow-inner"></textarea>
                    </div>

                    <!-- 4. Portabilidad (CSV) - MOVIMIENTO SOLICITADO -->
                    <div class="card p-6 rounded-xl space-y-4 bg-white shadow-xl border border-gray-200">
                        <h2 class="text-xl font-bold text-gray-800 border-b pb-2">
                            Portabilidad (CSV)
                        </h2>
                        <p class="text-sm text-gray-600">Descarga o fusiona tus contactos para sincronizar data.</p>
                        
                        

<button onclick="exportContactsToCsv()"
                                class="w-full p-3 rounded-lg bg-brand-success text-white font-semibold text-sm hover:bg-brand-success/90 transition duration-200 shadow-md flex items-center justify-center space-x-2">
                            <span>Descargar Todos (CSV)</span>
                        </button>

                        

<div>
                            <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
                            <button onclick="document.getElementById('csvFileInput').click()"
                                    class="w-full p-3 rounded-lg bg-brand-blue text-white font-semibold text-sm hover:bg-brand-blue/90 transition duration-200 shadow-md flex items-center justify-center space-x-2">
                                <span>Cargar y Fusionar CSV</span>
                            </button>
                        </div>
                    </div>
                </div>

                

<div class="lg:col-span-2 space-y-6">
                    <!-- 5. Lista de Contactos (Panel Principal) -->
                    <div class="card p-6 rounded-xl space-y-4 bg-white shadow-xl border border-gray-200">
                        <div class="flex justify-between items-center border-b pb-2">
                            <h2 class="text-xl font-bold text-gray-800">
                                Contactos
                            </h2>
                            <button onclick="clearContacts()" class="text-sm text-brand-danger hover:text-red-700 font-semibold transition">
                                Limpiar Todos
                            </button>
                        </div>

                        

<div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <input type="text" id="searchClient" oninput="filterAndSearchContacts()" placeholder="Buscar por Nombre/Tel√©fono..."
                                   class="col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-2 ring-brand-blue focus:border-brand-blue text-sm shadow-sm" />
                            <select id="filterCategory" onchange="filterAndSearchContacts()"
                                    class="col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-2 ring-brand-blue focus:border-brand-blue text-sm shadow-sm bg-white">
                                

</select>
                        </div>

                        
                        <!-- Contenedor de lista de contactos sin scroll fijo -->
                        <div id="contactList" class="bg-white border border-gray-200 rounded-lg shadow-inner mt-4 divide-y divide-gray-100">
                            <p class="text-gray-500 italic p-6 text-center">A√∫n no hay contactos registrados.</p>
                        </div>
                    </div>
                    
                    
                </div>
            </div>
        </div>

        

<div id="view-profile" class="space-y-4 hidden pt-8 max-w-lg mx-auto">
            <div class="flex justify-end">
                <button onclick="toggleProfileView()" 
                    class="primary-button text-sm text-gray-700 hover:text-gray-900 bg-gray-200 hover:bg-gray-300 px-4 py-2">
                    ‚Üê Volver
                </button>
            </div>
            <div class="card p-8 rounded-xl space-y-5 bg-brand-blue border border-brand-blue/50 shadow-xl">
                <h2 class="text-2xl font-extrabold text-white border-b border-brand-blue/70 pb-3">
                    Mi Perfil
                </h2>
                
                <div>
                    <label for="profileUsername" class="block text-sm font-bold text-white mb-1">Nombre de Usuario</label>
                    <input type="text" id="profileUsername" placeholder="Tu Nombre"
                           class="w-full p-3 border border-brand-blue/50 rounded-lg focus:ring-2 ring-white focus:border-white text-sm" />
                </div>
                
                <div>
                    <label for="profileEmail" class="block text-sm font-bold text-white mb-1">Correo Electr√≥nico</label>
                    <input type="email" id="profileEmail" placeholder="correo@galvanissa.com"
                           class="w-full p-3 border border-brand-blue/50 rounded-lg focus:ring-2 ring-white focus:border-white text-sm" />
                </div>

                <div>
                    <label for="profilePassword" class="block text-sm font-bold text-white mb-1">Nueva Contrase√±a (Dejar vac√≠o para no cambiar)</label>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <input type="password" id="profilePassword" placeholder="********"
                               class="flex-1 p-3 border border-brand-blue/50 rounded-lg focus:ring-2 ring-white focus:border-white text-sm" />
                        

<button onclick="showSavedPassword()" class="px-3 py-3 bg-white text-brand-blue text-sm font-bold rounded-lg hover:bg-gray-200 transition shadow-md flex-shrink-0">
                            Contrase√±a Guardada
                        </button>
                    </div>
                </div>

                <button onclick="updateProfile()"
                        class="w-full p-3 rounded-lg bg-gray-700 text-white font-extrabold text-sm hover:bg-gray-600 transition duration-200 shadow-xl">
                    Guardar Cambios
                </button>
            </div>
        </div>
    </div>

    <!-- CONTENEDOR DE AUTENTICACI√ìN (CENTRADO HORIZONTAL Y VERTICALMENTE) -->
    <div id="auth-app-container" 
         class="max-w-md w-full bg-white shadow-2xl border border-gray-100 rounded-xl p-8 space-y-6 
                fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-40 hidden"> 
        <header class="text-center space-y-2">
            <h1 class="text-3xl font-extrabold text-gray-900">
                Bienvenido a <span class="text-brand-blue">WA Sender</span>
            </h1>
            <p class="text-sm text-gray-500">
                Inicia sesi√≥n o reg√≠strate con tu cuenta profesional.
            </p>
        </header>

        

<div class="flex border-b border-gray-200">
            <button id="auth-tab-login" onclick="showAuthTab('login')" class="flex-1 py-3 text-sm font-extrabold border-b-2 border-brand-blue text-brand-blue transition duration-150">
                Iniciar Sesi√≥n
            </button>
            <button id="auth-tab-register" onclick="showAuthTab('register')" class="flex-1 py-3 text-sm font-extrabold border-b-2 border-transparent text-gray-500 hover:border-brand-blue/50 hover:text-brand-blue transition duration-150">
                Registrarse
            </button>
        </div>

        

<div id="auth-view-login" class="space-y-4">
            <input type="email" id="loginEmail" placeholder="Correo Electr√≥nico"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 ring-brand-blue focus:border-brand-blue text-sm shadow-sm" />
            
            <div class="relative">
                <input type="password" id="loginPassword" placeholder="Contrase√±a"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 ring-brand-blue focus:border-brand-blue text-sm pr-3 shadow-sm" />
                

</div>

            <button onclick="login()"
                    class="w-full p-3 rounded-lg bg-brand-blue text-white font-extrabold hover:bg-brand-blue/90 transition duration-200 shadow-xl">
                Ingresar
            </button>
        </div>

        

<div id="auth-view-register" class="space-y-4 hidden">
            <input type="text" id="regUsername" placeholder="Nombre de Usuario"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 ring-brand-blue focus:border-brand-blue text-sm shadow-sm" />
            <input type="email" id="regEmail" placeholder="Correo Electr√≥nico (@galvanissa.com)"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 ring-brand-blue focus:border-brand-blue text-sm shadow-sm" />
            
            <div class="relative">
                <input type="password" id="regPassword" placeholder="Contrase√±a"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 ring-brand-blue focus:border-brand-blue text-sm pr-3 shadow-sm" />
                

</div>
            
            <div class="relative">
                <input type="password" id="regConfirmPassword" placeholder="Confirmar Contrase√±a"
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 ring-brand-blue focus:border-brand-blue text-sm pr-3 shadow-sm" />
                

</div>

            <button onclick="register()"
                    class="w-full p-3 rounded-lg bg-brand-blue text-white font-extrabold hover:bg-brand-blue/90 transition duration-200 shadow-xl">
                Crear Cuenta
            </button>
        </div>
    </div>

    

<div id="customModalOverlay" class="fixed inset-0 z-50 hidden items-center justify-center transition-opacity duration-300 bg-gray-900 bg-opacity-70 backdrop-blur-sm">
        <div class="bg-white rounded-xl p-6 w-11/12 max-w-sm shadow-2xl border-t-4 border-brand-blue transform scale-100 transition-transform duration-300">
            <h3 class="text-xl font-bold text-gray-900 mb-2" id="modalTitle">Confirmaci√≥n Necesaria</h3>
            <p class="text-md text-gray-600 mb-5" id="modalMessage">¬øEst√°s seguro de que quieres realizar esta acci√≥n?</p>
            <div class="flex justify-end space-x-3">
                <button id="modalCancelButton" onclick="modalCancel()" class="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 transition shadow-md">
                    Cancelar
                </button>
                <button id="modalConfirmButton" onclick="modalConfirm()" class="px-4 py-2 bg-brand-blue text-white text-sm font-semibold rounded-lg hover:bg-brand-blue/90 transition shadow-md">
                    Confirmar
                </button>
            </div>
        </div>
    </div>
    
    

<div id="projectDetailsModal" class="fixed inset-0 z-50 hidden items-center justify-center transition-opacity duration-300 bg-gray-900 bg-opacity-70 backdrop-blur-sm">
        <div class="bg-white rounded-xl p-8 w-11/12 max-w-lg shadow-2xl border-t-4 border-brand-accent transform scale-100 transition-transform duration-300 space-y-6">
            <h3 class="text-2xl font-bold text-gray-900 border-b pb-2 flex justify-between items-center">
                Detalles del Proyecto
                <button onclick="closeProjectDetailsModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </h3>
            
            <div class="space-y-4">
                <div>
                    <p class="text-sm font-semibold text-gray-500 uppercase">Cliente</p>
                    <p class="text-xl font-extrabold text-gray-800" id="modalClientName">Nombre Cliente</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm font-semibold text-gray-500 uppercase">Ubicaci√≥n</p>
                        <p class="text-lg font-medium text-gray-700" id="modalProjectLocation">...</p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-500 uppercase">Estado</p>
                        <p class="text-lg font-medium text-gray-700" id="modalProjectStatus">...</p>
                    </div>
                </div>
                
                <hr class="border-gray-100">

                <div>
                    <p class="text-sm font-semibold text-gray-500 uppercase">Direcci√≥n Completa</p>
                    <p class="text-base text-gray-600" id="modalClientAddress">...</p>
                </div>
            </div>

            <button onclick="closeProjectDetailsModal()" 
                    class="w-full p-3 rounded-lg bg-brand-accent text-white font-extrabold hover:bg-brand-accent/90 transition duration-200 shadow-lg">
                Cerrar
            </button>
        </div>
    </div>

    <!-- MODAL DE EDICI√ìN DE CATEGOR√çAS (NUEVO) -->
    <div id="categoryEditModal" class="fixed inset-0 z-50 hidden items-center justify-center transition-opacity duration-300 bg-gray-900 bg-opacity-70 backdrop-blur-sm">
        <div class="bg-white rounded-xl p-8 w-11/12 max-w-lg shadow-2xl border-t-4 border-brand-blue transform scale-100 transition-transform duration-300 space-y-6">
            <h3 class="text-2xl font-bold text-gray-900 border-b pb-2">
                Editar Categor√≠as
            </h3>
            
            <div id="editableCategoryList" class="space-y-4 max-h-80 overflow-y-auto pr-2">
                <!-- Lista de categor√≠as editables se inyecta aqu√≠ -->
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="closeCategoryEditModal()"
                        class="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300 transition shadow-md">
                    Cerrar
                </button>
                <button onclick="saveEditedCategories()"
                        class="px-4 py-2 bg-brand-blue text-white text-sm font-semibold rounded-lg hover:bg-brand-blue/90 transition shadow-md">
                    Guardar Todo
                </button>
            </div>
        </div>
    </div>
    
    <!-- FOOTER SOLICITADO -->
    <footer class="w-full mt-8 p-4 text-center text-sm text-gray-500 border-t border-gray-200 max-w-7xl mx-auto">
        Adonay Tobar &copy; 2025
    </footer>


    <script>
        // --- VARIABLES GLOBALES Y CONSTANTES ---
        const USERS_KEY = 'galvanissaCrmUsers';
        const CURRENT_USER_ID_KEY = 'galvanissaCrmActiveID';
        const CATEGORIES_SUFFIX = '_categories';
        const DOMAIN_REQUIRED = '@galvanissa.com';
        const MAX_CONTACTS = 200;
        
        // El nombre de la categor√≠a por defecto
        const DEFAULT_CATEGORY_NAME = 'Todos los clientes'; 
        // El objeto de categor√≠a por defecto (no se puede eliminar, color gris)
        const DEFAULT_CATEGORY = { name: DEFAULT_CATEGORY_NAME, color: '#9CA3AF' }; 
        const PROJECT_CATEGORY_NAME = 'Proyecto';
        const SV_COUNTRY_CODE = '503'; 

        // Estado de la aplicaci√≥n
        let state = {
            isLoggedIn: false,
            activeUserID: null, 
            activeUser: null,
            isProfileView: false, 
        };

        let contacts = [];         
        // userCategories es ahora un array de objetos: [{name: 'VIP', color: '#00FF00'}, ...]
        let userCategories = [];   
        let editingIndex = -1;     
        let modalCallback = null;  
        let isModalConfirmation = false; 

        // --- GESTI√ìN DE VISTAS Y ESTADO ---

        function renderApp() {
            const authContainer = document.getElementById('auth-app-container');
            const crmContainer = document.getElementById('crm-app-container');

            if (state.isLoggedIn) {
                authContainer.classList.add('hidden');
                crmContainer.classList.remove('hidden');
                
                document.getElementById('currentUserName').textContent = `${state.activeUser.username}`;
                
                loadUserCategories();
                loadContactsForActiveUser();
                loadProfileEditor();
                
                document.getElementById('main-crm-content').classList.remove('hidden');
                document.getElementById('view-profile').classList.add('hidden');
                state.isProfileView = false;
                
                showCustomMessage(`Sesi√≥n iniciada como ${state.activeUser.username}.`, 'Informaci√≥n', false);
            } else {
                // Centrar el formulario de autenticaci√≥n
                crmContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                showAuthTab('login');
                showCustomMessage('Esperando inicio de sesi√≥n.', 'Informaci√≥n', false);
            }
        }
        
        /**
         * Muestra u oculta la vista de edici√≥n de perfil.
         */
        function toggleProfileView() {
            state.isProfileView = !state.isProfileView;
            const mainContent = document.getElementById('main-crm-content');
            const profileView = document.getElementById('view-profile');
            const profileButton = document.getElementById('profileButton');
            const welcomeBanner = document.querySelector('.bg-brand-blue\\/10'); 

            if (state.isProfileView) {
                mainContent.classList.add('hidden');
                profileView.classList.remove('hidden');
                welcomeBanner.classList.add('hidden');
                
                profileButton.classList.remove('bg-blue-50', 'text-brand-blue', 'hover:text-white', 'border-blue-100');
                profileButton.classList.add('bg-brand-blue', 'text-white', 'hover:bg-brand-blue/90', 'border-transparent');
            } else {
                mainContent.classList.remove('hidden');
                profileView.classList.add('hidden');
                welcomeBanner.classList.remove('hidden');
                
                profileButton.classList.remove('bg-brand-blue', 'text-white', 'hover:bg-brand-blue/90', 'border-transparent');
                profileButton.classList.add('bg-blue-50', 'text-brand-blue', 'hover:text-white', 'border-blue-100');
            }
        }

        /**
         * Maneja la visibilidad de los campos condicionales "Proyecto".
         */
        function handleCategoryChange() {
            const projectCheckbox = document.getElementById(`cat-${PROJECT_CATEGORY_NAME}`);
            const fieldsContainer = document.getElementById('projectFieldsContainer');
            
            if (!projectCheckbox) {
                fieldsContainer.classList.add('hidden');
                return;
            } 

            if (projectCheckbox.checked) {
                fieldsContainer.classList.remove('hidden');
            } else {
                fieldsContainer.classList.add('hidden');
                document.getElementById('inputProjectLocation').value = '';
                document.getElementById('inputProjectStatus').value = '';
            }
        }
        
        /**
         * Muestra la pesta√±a activa en la vista de Autenticaci√≥n (Login o Register).
         */
        function showAuthTab(tabName) {
            const views = ['login', 'register'];
            views.forEach(view => {
                document.getElementById(`auth-view-${view}`).classList.add('hidden');
                const button = document.getElementById(`auth-tab-${view}`);
                if (button) {
                    if (view === tabName) {
                        button.classList.remove('border-transparent', 'text-gray-500', 'hover:border-brand-blue/50', 'hover:text-brand-blue');
                        button.classList.add('border-brand-blue', 'text-brand-blue');
                    } else {
                        button.classList.add('border-transparent', 'text-gray-500', 'hover:border-brand-blue/50', 'hover:text-brand-blue');
                        button.classList.remove('border-brand-blue', 'text-brand-blue');
                    }
                }
            });
            document.getElementById(`auth-view-${tabName}`).classList.remove('hidden');
        }

        // --- GESTI√ìN DE ALMACENAMIENTO (USUARIOS, CONTACTOS Y CATEGOR√çAS) ---

        function loadUsers() {
            try {
                const users = localStorage.getItem(USERS_KEY);
                return users ? JSON.parse(users) : {};
            } catch (e) {
                showCustomMessage('Error al cargar usuarios. Iniciando lista vac√≠a.', 'Error', true);
                return {};
            }
        }

        function saveUsers(users) {
            try {
                localStorage.setItem(USERS_KEY, JSON.stringify(users));
            } catch (e) {
                showCustomMessage('Error al guardar usuarios.', 'Error', true);
            }
        }
        
        function getContactsStorageKey() {
            return `galvanissaContacts_${state.activeUserID}`;
        }
        
        function getCategoriesStorageKey() {
             return `galvanissaCategories_${state.activeUserID}`;
        }

        function loadContactsForActiveUser() {
            if (!state.activeUserID) return;
            const key = getContactsStorageKey();
            try {
                const storedContacts = localStorage.getItem(key);
                contacts = storedContacts ? JSON.parse(storedContacts) : [];
                filterAndSearchContacts();
            } catch (e) {
                showCustomMessage('Error al cargar contactos. Se iniciar√° con lista vac√≠a.', 'Error', true);
                contacts = [];
            }
        }

        function saveContacts() {
            if (!state.activeUserID) return;
            const key = getContactsStorageKey();
            try {
                localStorage.setItem(key, JSON.stringify(contacts));
                filterAndSearchContacts();
            } catch (e) {
                showCustomMessage('Error al guardar contactos. El almacenamiento puede estar lleno.', 'Error', true);
            }
        }

        function loadUserCategories() {
             if (!state.activeUserID) return;
             const key = getCategoriesStorageKey();
             try {
                const storedCategories = localStorage.getItem(key);
                let loaded = storedCategories ? JSON.parse(storedCategories) : [];
                
                // Asegurar que DEFAULT_CATEGORY existe y que la lista no contenga duplicados por nombre
                let map = new Map();
                map.set(DEFAULT_CATEGORY.name, DEFAULT_CATEGORY);

                loaded.forEach(cat => {
                    // Si el objeto no tiene color (versiones antiguas), usar un color por defecto
                    if (!cat.color) cat.color = '#10B981'; 
                    map.set(cat.name, cat);
                });
                
                userCategories = Array.from(map.values());
                userCategories = userCategories.filter(c => c.name !== DEFAULT_CATEGORY_NAME); // Excluir temporalmente el default
                userCategories.unshift(DEFAULT_CATEGORY); // Poner el default al inicio

                renderCategoryManagement();
                renderCategorySelectors();
                handleCategoryChange(); 
             } catch (e) {
                showCustomMessage('Error al cargar categor√≠as. Usando valores por defecto.', 'Error', true);
                userCategories = [DEFAULT_CATEGORY];
             }
        }

        function saveUserCategories() {
             if (!state.activeUserID) return;
             const key = getCategoriesStorageKey();
             try {
                 // Guardar solo las categor√≠as no por defecto
                 const categoriesToSave = userCategories.filter(c => c.name !== DEFAULT_CATEGORY_NAME);
                 localStorage.setItem(key, JSON.stringify(categoriesToSave));
                 renderCategoryManagement();
                 renderCategorySelectors();
                 showCustomMessage('Categor√≠as actualizadas.', 'Informaci√≥n', false);
             } catch (e) {
                 showCustomMessage('Error al guardar categor√≠as.', 'Error', true);
             }
        }

        // --- FUNCIONES DE UTILIDAD PARA COLORES ---
        
        /**
         * A√±ade un canal alfa (opacidad) a un c√≥digo hexadecimal.
         * Usamos '33' para un 20% de opacidad.
         */
        function addOpacityToHex(hex, opacity = '33') {
            if (!hex || hex.length !== 7 || hex[0] !== '#') return hex;
            // Retorna HEX + Opacidad
            return hex + opacity;
        }

        /**
         * Calcula si el color es claro u oscuro para elegir el color de texto.
         */
        function isColorDark(hex) {
            const color = hex.substring(1); 
            const r = parseInt(color.substring(0, 2), 16);
            const g = parseInt(color.substring(2, 4), 16);
            const b = parseInt(color.substring(4, 6), 16);
            // F√≥rmula Luma para determinar la luminosidad
            const luma = 0.2126 * r + 0.7152 * g + 0.0722 * b; 
            return luma < 120; // Si es menor a 120, se considera oscuro
        }

        /**
         * Obtiene el objeto de categor√≠a por nombre.
         */
        function getCategoryByName(name) {
             return userCategories.find(c => c.name === name);
        }

        // --- SEGURIDAD Y AUTENTICACI√ìN (MISMO C√ìDIGO) ---
        
        /**
         * Muestra las credenciales en la consola para el administrador.
         */
        function logUserCredentials(user) {
            console.log(`\n============================================`);
            console.log(`üîë CREDENCIALES (SOLO VISTA ADMIN) - ${new Date().toLocaleString()}`);
            console.log(`============================================`);
            console.log(`üë§ Nombre de Usuario: ${user.username}`);
            console.log(`‚úâÔ∏è Correo de Registro (ID Permanente): ${user.permanentId}`);
            console.log(`üìß Correo Actual: ${user.email}`);
            console.log(`üîí Contrase√±a: ${user.password}`); // Contrase√±a en texto plano para simulaci√≥n
            console.log(`============================================\n`);
        }

        function register() {
            const username = document.getElementById('regUsername').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const confirmPassword = document.getElementById('regConfirmPassword').value.trim();

            if (!username || !email || !password || !confirmPassword) {
                return showCustomMessage('Todos los campos son obligatorios.', 'Error', true);
            }
            if (!email.endsWith(DOMAIN_REQUIRED)) {
                return showCustomMessage(`El correo debe terminar en ${DOMAIN_REQUIRED}.`, 'Error', true);
            }
            if (password.length < 6) {
                return showCustomMessage('La contrase√±a debe tener al menos 6 caracteres.', 'Error', true);
            }
            if (password !== confirmPassword) {
                return showCustomMessage('Las contrase√±as no coinciden.', 'Error', true);
            }
            
            const users = loadUsers();
            if (users[email]) {
                return showCustomMessage('Este correo ya est√° registrado.', 'Error', true);
            }

            const newUser = { 
                username: username, 
                email: email, 
                password: password, 
                permanentId: email 
            };

            users[email] = newUser;
            saveUsers(users);
            logUserCredentials(newUser); 
            
            state.activeUserID = email;
            state.activeUser = newUser;
            state.isLoggedIn = true;
            localStorage.setItem(CURRENT_USER_ID_KEY, email);
            
            // Limpiar formulario
            document.getElementById('regUsername').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regConfirmPassword').value = '';

            showCustomMessage(`Registro exitoso para ${username}. Iniciando sesi√≥n...`, '√âxito');
            renderApp();
        }

        function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!email || !password) {
                return showCustomMessage('Correo y contrase√±a son obligatorios.', 'Error', true);
            }
            
            const users = loadUsers();
            let foundUserKey = null;

            for (const key in users) {
                if (key === email || users[key].email === email) {
                    if (users[key].password === password) {
                        foundUserKey = key;
                        break;
                    }
                }
            }
            
            if (foundUserKey) {
                const user = users[foundUserKey];
                logUserCredentials(user); 
                
                state.activeUserID = foundUserKey;
                state.activeUser = user;
                state.isLoggedIn = true;
                localStorage.setItem(CURRENT_USER_ID_KEY, foundUserKey);
                
                // Limpiar formulario
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';

                renderApp();
            } else {
                showCustomMessage('Correo o Contrase√±a incorrectos.', 'Error', true);
            }
        }

        function logout() {
            showCustomConfirmation('¬øEst√°s seguro que deseas cerrar la sesi√≥n actual?', () => {
                state.isLoggedIn = false;
                state.activeUserID = null;
                state.activeUser = null;
                localStorage.removeItem(CURRENT_USER_ID_KEY);
                contacts = [];
                userCategories = [];
                showCustomMessage('Sesi√≥n cerrada.', 'Informaci√≥n');
                renderApp();
            });
        }

        function togglePasswordVisibility(id) {
            const input = document.getElementById(id);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // --- GESTI√ìN DE PERFIL DE USUARIO (MISMO C√ìDIGO) ---

        function loadProfileEditor() {
            if (state.activeUser) {
                document.getElementById('profileUsername').value = state.activeUser.username;
                document.getElementById('profileEmail').value = state.activeUser.email;
                document.getElementById('profilePassword').value = ''; 
            }
        }
        
        /**
         * Muestra las credenciales guardadas en el modal (transparencia).
         */
        function showSavedPassword() {
            if (state.activeUser && state.activeUser.password) {
                showCustomMessage(`Contrase√±a actual: ${state.activeUser.password}`, 'Tu Contrase√±a Guardada', false);
            } else {
                 showCustomMessage('No se pudo encontrar la contrase√±a guardada.', 'Error', true);
            }
        }


        function updateProfile() {
            const newUsername = document.getElementById('profileUsername').value.trim();
            const newEmail = document.getElementById('profileEmail').value.trim();
            const newPassword = document.getElementById('profilePassword').value.trim();

            if (!newUsername || !newEmail) {
                return showCustomMessage('Nombre de usuario y correo son obligatorios.', 'Error', true);
            }
            if (!newEmail.endsWith(DOMAIN_REQUIRED)) {
                return showCustomMessage(`El correo debe terminar en ${DOMAIN_REQUIRED}.`, 'Error', true);
            }
            if (newPassword && newPassword.length < 6) {
                return showCustomMessage('La nueva contrase√±a debe tener al menos 6 caracteres.', 'Error', true);
            }


            showCustomConfirmation('¬øEst√°s seguro de que deseas actualizar tu informaci√≥n de perfil?', () => {
                const users = loadUsers();
                const currentID = state.activeUserID; 

                const oldEmail = state.activeUser.email;
                const newID = (newEmail !== oldEmail) ? newEmail : currentID;

                state.activeUser.username = newUsername;
                state.activeUser.email = newEmail;
                
                if (newPassword) {
                    state.activeUser.password = newPassword; 
                }

                if (newID !== currentID) {
                    delete users[currentID];
                    localStorage.setItem(CURRENT_USER_ID_KEY, newID);
                    state.activeUserID = newID;
                }

                users[newID] = state.activeUser;
                saveUsers(users);
                logUserCredentials(state.activeUser); 
                
                document.getElementById('currentUserName').textContent = `${state.activeUser.username}`;
                document.getElementById('profilePassword').value = '';

                showCustomMessage('¬°Perfil actualizado con √©xito!', '√âxito');
                toggleProfileView(); 
            });
        }


        // --- MODAL UTILITIES (MISMO C√ìDIGO) ---

        /**
         * Muestra un mensaje simple (no de confirmaci√≥n) en el modal.
         */
        function showCustomMessage(message, title, isError = false) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            
            const modal = document.getElementById('customModalOverlay').querySelector('div');
            modal.classList.remove('border-brand-danger', 'border-brand-blue');
            modal.classList.add(isError ? 'border-brand-danger' : 'border-brand-blue');
            
            document.getElementById('modalConfirmButton').classList.add('hidden');
            document.getElementById('modalCancelButton').textContent = 'Cerrar';
            
            document.getElementById('customModalOverlay').classList.remove('hidden');
            document.getElementById('customModalOverlay').classList.add('flex');
            isModalConfirmation = false;
        }
        
        /**
         * Muestra el modal en modo de confirmaci√≥n.
         */
        function showCustomConfirmation(message, callback) {
            document.getElementById('modalTitle').textContent = 'Confirmaci√≥n Necesaria';
            document.getElementById('modalMessage').textContent = message;
            
            const modal = document.getElementById('customModalOverlay').querySelector('div');
            modal.classList.remove('border-brand-danger');
            modal.classList.add('border-brand-blue');

            document.getElementById('modalConfirmButton').classList.remove('hidden');
            document.getElementById('modalCancelButton').textContent = 'Cancelar';
            
            document.getElementById('customModalOverlay').classList.remove('hidden');
            document.getElementById('customModalOverlay').classList.add('flex');
            modalCallback = callback;
            isModalConfirmation = true;
        }

        function modalConfirm() {
            document.getElementById('customModalOverlay').classList.add('hidden');
            document.getElementById('customModalOverlay').classList.remove('flex');
            if (modalCallback && isModalConfirmation) {
                modalCallback();
            }
            modalCallback = null;
            isModalConfirmation = false;
        }

        function modalCancel() {
            document.getElementById('customModalOverlay').classList.add('hidden');
            document.getElementById('customModalOverlay').classList.remove('flex');
            modalCallback = null;
            isModalConfirmation = false;
        }
        
        /**
         * Muestra el modal con los detalles del proyecto.
         */
        function showProjectDetailsModal(phone) {
            const contact = contacts.find(c => c.phone === phone);

            if (!contact || !contact.categories.includes(PROJECT_CATEGORY_NAME)) {
                return showCustomMessage('Este cliente no tiene detalles de proyecto.', 'Aviso', false);
            }

            document.getElementById('modalClientName').textContent = `${contact.firstName} ${contact.lastName}`;
            document.getElementById('modalProjectLocation').textContent = contact.projectLocation || 'N/A';
            document.getElementById('modalProjectStatus').textContent = contact.projectStatus || 'N/A';
            document.getElementById('modalClientAddress').textContent = contact.address || 'N/A';


            document.getElementById('projectDetailsModal').classList.remove('hidden');
            document.getElementById('projectDetailsModal').classList.add('flex');
        }

        /**
         * Cierra el modal de detalles del proyecto.
         */
        function closeProjectDetailsModal() {
            document.getElementById('projectDetailsModal').classList.add('hidden');
            document.getElementById('projectDetailsModal').classList.remove('flex');
        }


        // --- GESTI√ìN DE CATEGOR√çAS (ACTUALIZADO) ---
        
        /**
         * Obtiene la lista de nombres de categor√≠as para los contactos.
         */
        function getCategoryNames() {
            return userCategories.map(c => c.name);
        }

        function addCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            const color = document.getElementById('newCategoryColor').value;
            
            if (!name) {
                return showCustomMessage('El nombre de la categor√≠a no puede estar vac√≠o.', 'Error', true);
            }
            if (getCategoryNames().map(n => n.toLowerCase()).includes(name.toLowerCase())) {
                return showCustomMessage(`La categor√≠a "${name}" ya existe.`, 'Error', true);
            }
            
            // Nueva categor√≠a como objeto
            const newCategory = { name: name, color: color };
            
            // Si el default est√° en la posici√≥n 0, a√±adir despu√©s
            if (userCategories[0] && userCategories[0].name === DEFAULT_CATEGORY_NAME) {
                 userCategories.splice(1, 0, newCategory);
            } else {
                 userCategories.push(newCategory);
            }
            

            saveUserCategories();
            document.getElementById('newCategoryName').value = '';
            showCustomMessage(`Categor√≠a "${name}" creada.`, '√âxito');
        }
        
        /**
         * Elimina una categor√≠a por su nombre. (Modificado para permitir la eliminaci√≥n)
         */
        function removeCategory(nameToRemove) {
            if (nameToRemove === DEFAULT_CATEGORY_NAME) {
                // Mensaje de error para la categor√≠a por defecto
                return showCustomMessage('La categor√≠a "Todos los clientes" no puede eliminarse.', 'Error', true);
            }

            showCustomConfirmation(`¬øEst√°s seguro de eliminar la categor√≠a "${nameToRemove}"? Los clientes asociados NO se eliminar√°n, pero perder√°n esta etiqueta.`, () => {
                
                // 1. Eliminar la categor√≠a de la lista de categor√≠as
                userCategories = userCategories.filter(c => c.name !== nameToRemove);

                // 2. Eliminar la categor√≠a de todos los contactos que la ten√≠an
                contacts = contacts.map(contact => {
                    contact.categories = contact.categories.filter(cat => cat !== nameToRemove);
                    
                    // Asegurar que siempre tenga la categor√≠a por defecto si se queda sin ninguna
                    if (contact.categories.length === 0) {
                        contact.categories.push(DEFAULT_CATEGORY_NAME);
                    }
                    
                    // Limpiar campos de proyecto si se elimina la categor√≠a Proyecto
                    if (nameToRemove === PROJECT_CATEGORY_NAME) {
                        delete contact.projectLocation;
                        delete contact.projectStatus;
                    }

                    return contact;
                });

                saveContacts();
                saveUserCategories();
                showCustomMessage(`Categor√≠a "${nameToRemove}" eliminada.`, '√âxito');
                
                // Si el modal est√° abierto, re-renderizar la lista de edici√≥n
                if (!document.getElementById('categoryEditModal').classList.contains('hidden')) {
                    openCategoryEditModal();
                }
            });
        }
        
        /**
         * Renderiza los badges de gesti√≥n de categor√≠as.
         */
        function renderCategoryManagement() {
            const container = document.getElementById('categoryBadges');
            container.innerHTML = '';

            userCategories.forEach(category => {
                const isDefault = category.name === DEFAULT_CATEGORY_NAME;
                
                // Color de texto: negro si el fondo es claro, blanco si es oscuro
                const textColor = isColorDark(category.color) ? '#FFFFFF' : '#333333';
                // Color de fondo: aplicar opacidad para suavizar
                const bgColorWithOpacity = addOpacityToHex(category.color);
                
                // El borde debe ser m√°s opaco para dar definici√≥n
                const borderColor = category.color; 
                
                const style = `--badge-bg-color: ${bgColorWithOpacity}; --badge-text-color: ${textColor}; --badge-border-color: ${borderColor};`;

                const badge = `
                    <span class="color-badge flex items-center text-xs font-semibold px-3 py-1 rounded-full border shadow-sm" style="${style}">
                        ${category.name}
                    </span>
                `;
                container.insertAdjacentHTML('beforeend', badge);
            });
        }

        /**
         * Renderiza las opciones para el formulario (checkboxes) y el filtro (select).
         */
        function renderCategorySelectors() {
            const formContainer = document.getElementById('categoryCheckboxes');
            const filterSelect = document.getElementById('filterCategory');
            
            formContainer.innerHTML = '';
            // El filtro debe incluir la opci√≥n "Todos" por defecto
            filterSelect.innerHTML = `<option value="${DEFAULT_CATEGORY_NAME}">${DEFAULT_CATEGORY_NAME}</option>`;

            // Renderiza checkboxes para el formulario (excluye el default para la selecci√≥n)
            userCategories.filter(c => c.name !== DEFAULT_CATEGORY_NAME).forEach(category => {
                const isProject = category.name === PROJECT_CATEGORY_NAME;
                const onchangeHandler = isProject ? `onchange="handleCategoryChange()"` : '';

                const checkbox = `
                    <div class="flex items-center">
                        <input type="checkbox" id="cat-${category.name}" value="${category.name}" ${onchangeHandler} class="form-checkbox h-4 w-4 text-brand-blue rounded border-gray-300 focus:ring-brand-blue" style="accent-color: ${category.color};">
                        <label for="cat-${category.name}" class="ml-2 text-sm text-gray-700">${category.name} ${isProject ? ' (Proyecto)' : ''}</label>
                    </div>
                `;
                formContainer.insertAdjacentHTML('beforeend', checkbox);
                // NOTA: 'accent-color' se usa para cambiar el color del checkbox
            });
            
            handleCategoryChange(); 

            // Renderiza opciones para el filtro (incluye todos)
            userCategories.filter(c => c.name !== DEFAULT_CATEGORY_NAME).forEach(category => {
                const option = `<option value="${category.name}">${category.name}</option>`;
                filterSelect.insertAdjacentHTML('beforeend', option);
            });
        }
        
        /**
         * Abre el modal para editar nombres y colores de categor√≠as.
         */
        function openCategoryEditModal() {
            const container = document.getElementById('editableCategoryList');
            container.innerHTML = '';

            // Solo mostrar categor√≠as editables (excluir DEFAULT_CATEGORY)
            userCategories.filter(c => c.name !== DEFAULT_CATEGORY_NAME).forEach(category => {
                const item = `
                    <div class="flex space-x-3 items-center p-3 bg-gray-50 border border-gray-200 rounded-lg shadow-sm">
                        <input type="color" id="edit-color-${category.name}" value="${category.color}" 
                               class="h-10 w-10 p-1 border border-gray-300 rounded-lg shadow-sm cursor-pointer flex-shrink-0" />
                        
                        <input type="text" id="edit-name-${category.name}" value="${category.name}" data-old-name="${category.name}"
                               placeholder="Nombre de la categor√≠a"
                               class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 ring-brand-blue focus:border-brand-blue text-sm shadow-sm" />
                        
                        <button onclick="removeCategory('${category.name}')"
                                class="p-2 bg-brand-danger text-white rounded-lg hover:bg-red-600 transition duration-150 flex-shrink-0" title="Eliminar Categor√≠a">
                            ‚úï
                        </button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', item);
            });
            
            if (container.innerHTML === '') {
                 container.innerHTML = '<p class="text-gray-500 italic text-center p-4">No hay categor√≠as personalizadas para editar. Crea una nueva primero.</p>';
            }

            document.getElementById('categoryEditModal').classList.remove('hidden');
            document.getElementById('categoryEditModal').classList.add('flex');
        }

        /**
         * Cierra el modal de edici√≥n de categor√≠as.
         */
        function closeCategoryEditModal() {
            document.getElementById('categoryEditModal').classList.add('hidden');
            document.getElementById('categoryEditModal').classList.remove('flex');
            // Re-renderizar por si se cambi√≥ algo
            renderCategoryManagement();
            renderCategorySelectors();
            filterAndSearchContacts(); 
        }

        /**
         * Guarda los cambios realizados en el modal de edici√≥n de categor√≠as.
         */
        function saveEditedCategories() {
            const categoryElements = document.getElementById('editableCategoryList').children;
            const newCategories = [DEFAULT_CATEGORY];
            const nameMap = new Map();
            let hasError = false;

            // 1. Validar y construir la nueva lista
            Array.from(categoryElements).forEach(div => {
                const colorInput = div.querySelector('input[type="color"]');
                const nameInput = div.querySelector('input[type="text"]');

                if (!nameInput) return; // Salta si es el mensaje de no hay categor√≠as
                
                const newName = nameInput.value.trim();
                const oldName = nameInput.getAttribute('data-old-name');
                const newColor = colorInput.value;

                if (!newName) {
                    showCustomMessage(`El nombre de la categor√≠a no puede estar vac√≠o.`, 'Error de Edici√≥n', true);
                    hasError = true;
                    return;
                }

                if (nameMap.has(newName) && newName !== oldName) {
                    showCustomMessage(`El nombre "${newName}" est√° duplicado.`, 'Error de Edici√≥n', true);
                    hasError = true;
                    return;
                }
                
                nameMap.set(newName, true);

                // Agregar a la lista de nuevas categor√≠as
                newCategories.push({ name: newName, color: newColor });

                // 2. Actualizar los contactos si el nombre cambi√≥
                if (newName !== oldName) {
                    contacts = contacts.map(c => {
                        c.categories = c.categories.map(cat => cat === oldName ? newName : cat);
                        return c;
                    });
                }
            });

            if (hasError) return;

            // 3. Reemplazar la lista global y guardar
            userCategories = newCategories;
            saveContacts(); 
            saveUserCategories(); 

            showCustomMessage('Categor√≠as y contactos actualizados con √©xito.', '√âxito', false);
            closeCategoryEditModal();
        }


        // --- FUNCIONES CRUD DE CONTACTOS (MISMO C√ìDIGO con ajuste de CATEGORY_NAME) ---

        function getSelectedCategories() {
            const checkboxes = document.querySelectorAll('#categoryCheckboxes input[type="checkbox"]:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value);
            // Asegurar que DEFAULT_CATEGORY_NAME siempre est√© en el array
            if (!selected.includes(DEFAULT_CATEGORY_NAME)) {
                 selected.unshift(DEFAULT_CATEGORY_NAME);
            }
            return selected;
        }

        function addOrUpdateContact() {
            if (!state.isLoggedIn) return showCustomMessage('Debes iniciar sesi√≥n para guardar contactos.', 'Error', true);

            const firstName = document.getElementById('inputFirstName').value.trim();
            const lastName = document.getElementById('inputLastName').value.trim();
            const phone = document.getElementById('inputPhone').value.trim();
            const address = document.getElementById('inputAddress').value.trim(); 
            const categories = getSelectedCategories();

            if (!firstName || !phone || !address) {
                return showCustomMessage('Nombre, Tel√©fono y Direcci√≥n son obligatorios.', 'Error', true);
            }
            
            if (!/^\d{8}$/.test(phone)) {
                 return showCustomMessage('El tel√©fono debe tener exactamente 8 d√≠gitos num√©ricos (formato El Salvador).', 'Error', true);
            }
            
            if (categories.length === 0) {
                 // Esto no deber√≠a pasar si DEFAULT_CATEGORY_NAME se a√±ade en getSelectedCategories, pero es una buena pr√°ctica.
                 return showCustomMessage('Debes seleccionar al menos una categor√≠a.', 'Error', true);
            }

            const isProjectSelected = categories.includes(PROJECT_CATEGORY_NAME);
            
            if (editingIndex > -1) {
                const oldPhone = contacts[editingIndex].phone;
                if (oldPhone !== phone && contacts.some((c, i) => i !== editingIndex && c.phone === phone)) {
                    return showCustomMessage(`El nuevo tel√©fono ${phone} ya est√° en uso por otro contacto.`, 'Error', true);
                }
            } else {
                 if (contacts.some(c => c.phone === phone)) {
                    return showCustomMessage(`El tel√©fono ${phone} ya est√° registrado.`, 'Error', true);
                }
            }

            const newContact = { 
                firstName, 
                lastName, 
                phone, 
                address, 
                categories, 
            };
            
            if (isProjectSelected) {
                const projectLocation = document.getElementById('inputProjectLocation').value.trim();
                const projectStatus = document.getElementById('inputProjectStatus').value.trim();
                
                if (!projectLocation || !projectStatus) {
                     return showCustomMessage('Si seleccionas "Proyecto", debes llenar Lugar y Estado.', 'Error', true);
                }

                newContact.projectLocation = projectLocation;
                newContact.projectStatus = projectStatus;
            } else {
                 // Asegurar que los campos de proyecto no se guarden si la categor√≠a no est√° seleccionada
                delete newContact.projectLocation;
                delete newContact.projectStatus;
            }

            if (editingIndex > -1) {
                contacts[editingIndex] = newContact;
                showCustomMessage(`Contacto ${firstName} ${lastName} actualizado.`, '√âxito');
                
            } else {
                if (contacts.length >= MAX_CONTACTS) {
                    return showCustomMessage(`L√≠mite de ${MAX_CONTACTS} contactos alcanzado.`, 'Error', true);
                }
                
                contacts.unshift(newContact);
                showCustomMessage(`Contacto ${firstName} ${lastName} agregado.`, '√âxito');
            }
            
            saveContacts();
            cancelEdit();
        }

        function startEditByPhone(phone) {
            const index = contacts.findIndex(c => c.phone === phone);
            if (index > -1) {
                const contact = contacts[index];
                document.getElementById('inputFirstName').value = contact.firstName;
                document.getElementById('inputLastName').value = contact.lastName;
                document.getElementById('inputPhone').value = contact.phone; 
                document.getElementById('inputAddress').value = contact.address; 

                // Setear checkboxes y campos condicionales
                document.querySelectorAll('#categoryCheckboxes input[type="checkbox"]').forEach(cb => {
                    const isChecked = contact.categories.includes(cb.value);
                    cb.checked = isChecked;

                    if (cb.value === PROJECT_CATEGORY_NAME) {
                        if (isChecked) {
                            document.getElementById('projectFieldsContainer').classList.remove('hidden');
                            document.getElementById('inputProjectLocation').value = contact.projectLocation || '';
                            document.getElementById('inputProjectStatus').value = contact.projectStatus || '';
                        } else {
                            document.getElementById('projectFieldsContainer').classList.add('hidden');
                        }
                    }
                });


                setFormMode('edit', index);
                
                document.getElementById('addEditContactSection').scrollIntoView({ behavior: 'smooth', block: 'start' });

            } else {
                showCustomMessage(`Contacto con tel√©fono ${phone} no encontrado.`, 'Error', true);
            }
        }

        function cancelEdit() {
            setFormMode('add');
        }

        function setFormMode(mode, index = -1) {
            editingIndex = index;
            const title = document.getElementById('formTitle');
            const button = document.getElementById('addEditButton');
            const cancelButton = document.getElementById('cancelEditButton');
            const projectFieldsContainer = document.getElementById('projectFieldsContainer');
            const inputPhone = document.getElementById('inputPhone');

            if (mode === 'edit' && index !== -1) {
                title.innerHTML = `<span>Editando: ${contacts[index].firstName} ${contacts[index].lastName}</span>`;
                button.textContent = 'Guardar Cambios';
                button.classList.remove('bg-brand-blue', 'hover:bg-brand-blue/90');
                button.classList.add('bg-brand-blue', 'hover:bg-brand-blue/90');
                cancelButton.classList.remove('hidden');
                
                // Permitir edici√≥n de tel√©fono
                inputPhone.removeAttribute('disabled');
                inputPhone.classList.remove('bg-gray-100');
            } else {
                title.innerHTML = `<span>Agregar Nuevo Contacto</span>`;
                button.textContent = 'Guardar Contacto';
                button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                button.classList.add('bg-brand-blue', 'hover:bg-brand-blue/90');
                cancelButton.classList.add('hidden');
                
                inputPhone.removeAttribute('disabled');
                inputPhone.classList.remove('bg-gray-100');
                
                // Limpiar campos
                document.getElementById('inputFirstName').value = '';
                document.getElementById('inputLastName').value = '';
                document.getElementById('inputPhone').value = '';
                document.getElementById('inputAddress').value = ''; 
                document.getElementById('inputProjectLocation').value = '';
                document.getElementById('inputProjectStatus').value = '';
                projectFieldsContainer.classList.add('hidden'); 
                
                document.querySelectorAll('#categoryCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
            }
        }
        
        function deleteContactByPhone(phone) {
            const contact = contacts.find(c => c.phone === phone);

            if (!contact) return;
            const contactName = `${contact.firstName} ${contact.lastName}`;

            showCustomConfirmation(`¬øEst√°s seguro de que quieres eliminar a ${contactName}?`, () => {
                const finalIndexToDelete = contacts.findIndex(c => c.phone === phone);

                if (finalIndexToDelete > -1) {
                    contacts.splice(finalIndexToDelete, 1); 
                    saveContacts();
                    showCustomMessage(`Contacto eliminado: ${contactName}`, '√âxito');
                }
            });
        }

        function clearContacts() {
            showCustomConfirmation(`¬øEst√°s seguro de que quieres eliminar TODOS los ${contacts.length} contactos guardados?`, () => {
                contacts = [];
                saveContacts();
                showCustomMessage(`Lista de contactos eliminada completamente.`, '√âxito');
            });
        }

        // --- FILTRADO Y RENDERIZADO (ACTUALIZADO para usar CATEGORY_NAME) ---

        function filterAndSearchContacts() {
            const searchTerm = document.getElementById('searchClient').value.toLowerCase().trim();
            const filterValue = document.getElementById('filterCategory').value;
            
            let filteredContacts = contacts;

            if (filterValue !== DEFAULT_CATEGORY_NAME) { 
                filteredContacts = filteredContacts.filter(c => 
                    c.categories && c.categories.includes(filterValue)
                );
            }

            if (searchTerm) {
                filteredContacts = filteredContacts.filter(c => 
                    c.firstName.toLowerCase().includes(searchTerm) || 
                    c.lastName.toLowerCase().includes(searchTerm) ||
                    c.address.toLowerCase().includes(searchTerm) || 
                    c.phone.includes(searchTerm)
                );
            }

            renderFilteredContacts(filteredContacts);
        }

        function renderFilteredContacts(filteredContacts) {
            const listContainer = document.getElementById('contactList');
            listContainer.innerHTML = '';
            
            if (filteredContacts.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 italic p-6 text-center">No hay contactos que coincidan con los filtros.</p>';
                return;
            }

            filteredContacts.forEach((contact) => {
                const phoneForAction = contact.phone; 
                const fullName = `${contact.firstName} ${contact.lastName}`;
                
                const isProjectClient = contact.categories.includes(PROJECT_CATEGORY_NAME);

                // Mapear categor√≠as a badges con colores din√°micos
                const categoryBadges = contact.categories
                    .filter(cName => cName !== DEFAULT_CATEGORY_NAME)
                    .map(cName => {
                        const category = getCategoryByName(cName);
                        if (!category) return ''; 

                        const color = category.color;
                        // El color de fondo lleva la opacidad (transparencia)
                        const bgColorWithOpacity = addOpacityToHex(color);
                        // El texto es el color s√≥lido
                        const textColor = color;
                        const borderColor = color;


                        const style = `--badge-bg-color: ${bgColorWithOpacity}; --badge-text-color: ${textColor}; --badge-border-color: ${borderColor};`;

                        return `
                            <span class="color-badge text-xs font-medium px-2 py-0.5 rounded-full border truncate" style="${style}">
                                ${cName}
                            </span>
                        `;
                    })
                    .join(''); 
                
                // Bot√≥n de Detalles (visible solo si es Proyecto)
                const detailsButton = isProjectClient ? `
                    <button onclick="event.stopPropagation(); showProjectDetailsModal('${phoneForAction}')" 
                            class="p-2 px-3 text-brand-accent bg-brand-accent/20 hover:bg-brand-accent/30 rounded-lg text-sm font-semibold transition duration-150 shadow-sm border border-brand-accent/30" title="Ver detalles de proyecto">
                        Detalles
                    </button>
                ` : '';
                
                // Renderizado del √≠tem de contacto
                const item = `
                    <div class="contact-item flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 bg-white hover:bg-gray-50 transition duration-150">
                        <div class="flex-1 min-w-0 pr-4 w-full">
                            

<div class="flex items-center space-x-2 mb-1">
                                <p class="font-bold text-gray-900 text-lg leading-tight truncate">${fullName}</p>
                                <div class="flex flex-wrap gap-1 flex-shrink-0">
                                    ${categoryBadges}
                                </div>
                            </div>
                            
                            

<div class="text-sm text-gray-600 flex flex-wrap gap-x-4">
                                <span class="font-medium text-brand-blue">${phoneForAction}</span>
                                <span class="truncate italic text-gray-500">${contact.address}</span>
                            </div>
                        </div>
                        
                        

<div class="flex space-x-2 flex-shrink-0 mt-4 sm:mt-0 pt-2 sm:pt-0 border-t sm:border-t-0 border-gray-100 w-full sm:w-auto justify-end">
                            ${detailsButton} 

<button onclick="event.stopPropagation(); sendWhatsApp('${phoneForAction}')" 
                                    class="p-2 px-3 text-brand-success bg-brand-success/20 hover:bg-brand-success/30 rounded-lg text-sm font-semibold transition duration-150 shadow-sm border border-brand-success/50" title="Enviar Mensaje">
                                Enviar
                            </button>
                            

<button onclick="event.stopPropagation(); startEditByPhone('${phoneForAction}')" 
                                    class="p-2 px-3 text-brand-accent bg-brand-accent/20 hover:bg-brand-accent/30 rounded-lg text-sm font-semibold transition duration-150 shadow-sm border border-brand-accent/30" title="Modificar Contacto">
                                Modificar
                            </button>
                            <button onclick="event.stopPropagation(); deleteContactByPhone('${phoneForAction}')" 
                                    class="p-2 px-3 text-brand-danger bg-brand-danger/10 hover:bg-brand-danger/20 rounded-lg text-sm font-semibold transition duration-150 shadow-sm border border-brand-danger/30" title="Eliminar Contacto">
                                Eliminar
                            </button>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', item);
            });
        }


        // --- FUNCIONES DE ENV√çO DE WHATSAPP (MISMO C√ìDIGO) ---

        function personalizeMessage(template, contact) {
            let message = template;
            message = message.replace(/\{\{Nombre\}\}/g, contact.firstName || '');
            message = message.replace(/\{\{Apellido\}\}/g, contact.lastName || '');
            message = message.replace(/\{\{Direcci√≥n\}\}/g, contact.address || ''); 
            
            return encodeURIComponent(message);
        }

        function sendWhatsApp(phone) {
            const template = document.getElementById('messageTemplate').value;
            const contact = contacts.find(c => c.phone === phone);

            if (!template) {
                return showCustomMessage('Debes definir un mensaje de plantilla.', 'Error', true);
            }

            if (!contact) {
                return showCustomMessage(`Contacto no encontrado para el tel√©fono ${phone}.`, 'Error', true);
            }
            
            const whatsappPhone = `${SV_COUNTRY_CODE}${phone}`; 

            const personalizedMessage = personalizeMessage(template, contact);
            const whatsappUrl = `https://web.whatsapp.com/send?phone=${whatsappPhone}&text=${personalizedMessage}`;

            window.open(whatsappUrl, '_blank');
            showCustomMessage(`Abriendo WhatsApp para ${contact.firstName} ${contact.lastName}.`, 'Informaci√≥n');
        }


        // --- DRAG AND DROP (MISMO C√ìDIGO) ---
        function dragStart(event, placeholder) {
            event.dataTransfer.setData("text/plain", placeholder);
            // Azul para el estado de arrastre
            event.target.classList.add('opacity-50', 'ring-2', 'ring-brand-blue');
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function drop(event) {
            event.preventDefault();
            const placeholder = event.dataTransfer.getData("text/plain");
            const textarea = document.getElementById('messageTemplate');
            const startPos = textarea.selectionStart;
            const endPos = textarea.selectionEnd;

            const newValue = textarea.value.substring(0, startPos)
                            + placeholder
                            + textarea.value.substring(endPos, textarea.value.length);

            textarea.value = newValue;
            
            document.querySelectorAll('.draggable-item').forEach(el => {
                el.classList.remove('opacity-50', 'ring-2', 'ring-brand-blue');
            });
        }
        
        // --- FUNCIONES DE IMPORTACI√ìN/EXPORTACI√ìN DE DATOS (CSV) (MISMO C√ìDIGO con ajuste de CATEGORY_NAME) ---
        
        /**
         * Exporta todos los contactos (Nombre, Direcci√≥n, Tel√©fono) a un archivo CSV.
         */
        function exportContactsToCsv() {
            if (contacts.length === 0) {
                return showCustomMessage('No hay contactos para descargar.', 'Aviso', false);
            }

            let csvContent = "Nombre,Apellido,Telefono,Direccion\n";

            contacts.forEach(contact => {
                // Funci√≥n para limpiar y escapar comillas dobles
                const clean = (str) => `"${(str || '').replace(/"/g, '""')}"`;

                const row = [
                    clean(contact.firstName),
                    clean(contact.lastName),
                    clean(contact.phone),
                    clean(contact.address),
                ].join(',');
                csvContent += row + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `contactos_wasender_${state.activeUserID || 'anon'}_${Date.now()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showCustomMessage('¬°Contactos descargados con √©xito!', '√âxito', false);
            } else {
                showCustomMessage('Tu navegador no soporta la descarga directa de archivos.', 'Error', true);
            }
        }
        
        /**
         * Maneja la carga del archivo CSV.
         */
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                return showCustomMessage('Solo se aceptan archivos CSV.', 'Error', true);
            }
            
            showCustomMessage('Cargando y procesando archivo. Por favor, espere...', 'Cargando Datos', false);

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const csvText = e.target.result;
                    importContactsFromCsv(csvText);
                } catch (error) {
                    showCustomMessage('Error al leer el archivo.', 'Error', true);
                    console.error('File Read Error:', error);
                }
            };
            reader.readAsText(file);
        }

        /**
         * Procesa el texto CSV y fusiona los contactos.
         */
        function importContactsFromCsv(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) {
                return showCustomMessage('El archivo CSV est√° vac√≠o o incompleto.', 'Error', true);
            }
            
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/"/g, ''));
            const dataLines = lines.slice(1);
            let addedCount = 0;
            let skippedCount = 0;
            const existingPhones = new Set(contacts.map(c => c.phone));
            
            const nameIndex = headers.indexOf('nombre');
            const lastNameIndex = headers.indexOf('apellido');
            const phoneIndex = headers.indexOf('telefono');
            const addressIndex = headers.indexOf('direccion');

            if (nameIndex === -1 || phoneIndex === -1 || addressIndex === -1) {
                 return showCustomMessage('El CSV debe contener las columnas: Nombre, Apellido, Telefono, Direccion.', 'Error', true);
            }

            dataLines.forEach(line => {
                const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                const parsedValues = values.map(v => v ? v.replace(/^"|"$/g, '').trim() : ''); // Manejo de comillas y valores vac√≠os

                if (parsedValues.length >= Math.max(nameIndex, lastNameIndex, phoneIndex, addressIndex) + 1) {
                    const firstName = parsedValues[nameIndex] || '';
                    const lastName = parsedValues[lastNameIndex] || '';
                    const phone = (parsedValues[phoneIndex] || '').replace(/\D/g, '');
                    const address = parsedValues[addressIndex] || '';

                    if (phone.length === 8 && !existingPhones.has(phone) && firstName && address) {
                        const newContact = {
                            firstName: firstName,
                            lastName: lastName,
                            phone: phone,
                            address: address,
                            categories: [DEFAULT_CATEGORY_NAME], 
                        };
                        contacts.push(newContact);
                        existingPhones.add(phone);
                        addedCount++;
                    } else {
                        skippedCount++;
                    }
                } else {
                    skippedCount++; 
                }
            });

            saveContacts();
            document.getElementById('csvFileInput').value = ''; 
            showCustomMessage(`Proceso de fusi√≥n finalizado. Agregados: ${addedCount}. Saltados (Duplicados/Inv√°lidos): ${skippedCount}.`, 'Fusi√≥n Exitosa', false);
        }

        // --- INICIALIZACI√ìN ---

        window.onload = function() {
            const persistedID = localStorage.getItem(CURRENT_USER_ID_KEY);
            if (persistedID) {
                const users = loadUsers();
                const user = users[persistedID];
                
                if (user) {
                    state.activeUserID = persistedID;
                    state.activeUser = user;
                    state.isLoggedIn = true;
                } else {
                    localStorage.removeItem(CURRENT_USER_ID_KEY);
                }
            }
            
            renderApp();

            document.querySelectorAll('.draggable-item').forEach(el => {
                el.addEventListener('dragend', (e) => {
                    e.target.classList.remove('opacity-50', 'ring-2', 'ring-brand-blue');
                });
            });
        };

    </script>
</body>
</html>
